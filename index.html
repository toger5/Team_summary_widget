<!--
 Copyright 2020 The Matrix.org Foundation C.I.C.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

         http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Team Summary</title>
    <!--
      ADD THE WIDGET:
        /addwidget https://golden-klepon-1b24b1.netlify.app/#/?widgetId=$matrix_widget_id&userId=$matrix_user_id
    -->
    <link href="index.css" rel="stylesheet" />
  </head>
  <body>
    <!-- The widget will be loaded into this container -->
    <div id="container">Loading...</div>

    <!-- Include the widget library -->
    <script src="api.js"></script>

    <!-- Bring in some utilities that aren't critical to the example -->
    <script src="utils.js"></script>

    <!-- The actual widget functionality -->
    <script type="text/javascript">
      const TEAM_SUMMARY_STATE = "io.element.team_summary";
      const TEAM_SUMMARY_KEY = "summary";

      const INITIAL_WIDGET_HTML =
        `<h3>welcome to the Team Summary widget</h3>
      The content of this widget is stored in a state event.<br>
      Edit the value (<code>` +
        TEAM_SUMMARY_STATE +
        `/` +
        TEAM_SUMMARY_KEY +
        `/content/html</code>) of the <code>` +
        TEAM_SUMMARY_STATE + `</code>
        state event to edit this page.<br>
      <br>
      It is recommended to create the html with other tools (for example 
      <a href="https://markdowntohtml.com/">https://markdowntohtml.com/</a>) remove the newlines characters and paste it into the state event.<br>
      <h4>Edit the state event</h4>
      The state event can be edited by typing <code>/devtools</code> and selecting <b>Explore room state</b>.`;

      try {
        const qs = parseFragment();
        const widgetId = assertParam(qs, "widgetId");
        const userId = assertParam(qs, "userId");

        let teamDescription = "";

        const widgetApi = new mxwidgets.WidgetApi(widgetId);
        // Request capability for the state Event
        widgetApi.requestCapabilityToSendState(
          TEAM_SUMMARY_STATE,
          TEAM_SUMMARY_KEY
        );
        widgetApi.requestCapabilityToReceiveState(
          TEAM_SUMMARY_STATE,
          TEAM_SUMMARY_KEY
        );

        function createRoomSummaryStateEvent() {
          widgetApi.sendStateEvent(
            TEAM_SUMMARY_STATE,
            TEAM_SUMMARY_KEY,
            { html: INITIAL_WIDGET_HTML },
            null
          );
        }

        function createStateEvent() {
          widgetApi.sendStateEvent(
            TEAM_SUMMARY_STATE,
            TEAM_SUMMARY_KEY,
            { html: "CHANGE THE CONTENT OF YOUR PAGE " },
            null
          );
        }
        // }
        widgetApi.on(`action:send_event`, (teamDescriptionEv) => {
          switch (teamDescriptionEv.detail.data.type) {
            case "io.element.team_summary":
              console.log("New Team Summary Event:", teamDescriptionEv)
              teamDescriptionEv.preventDefault();
              widgetApi.transport.reply(teamDescriptionEv.detail, {});
              document.getElementById("teamDescription").innerHTML =
              teamDescriptionEv.detail.data.content.html;
              break;
          }
        }
        );

        widgetApi.on("ready", function () {
          // Fill in the basic widget details now that we're allowed to operate.
          document.getElementById("container").innerHTML =
            "<dev id='teamDescription'>" + "</div>";

          widgetApi
            .readStateEvents(TEAM_SUMMARY_STATE, 25, "summary", null)
            .then((events) => {
              if (events.length > 0) {
                console.log(events[0]);
                teamDescription = events[0];
                document.getElementById("teamDescription").innerHTML =
                  teamDescription.content.html;
              } else {
                createRoomSummaryStateEvent();
                location.reload();
              }
            });
        });

        // Start the widget as soon as possible too, otherwise the client might time us out.
        widgetApi.start();
      } catch (e) {
        handleError(e);
      }
    </script>
  </body>
</html>
